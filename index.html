<!DOCTYPE html>
<html>
<head>
    <title>Interventional Radiology</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" 
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" 
          crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<style>
    .main-heading {
        font-size: 15px;
    }
    #selectedLayer {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        font-size: 22px;
        text-shadow: 2px 2px 2px white;
        z-index: 100;
        text-align: center;
    }
    .building-label {
        font-size: 10px;
        padding: 2px 4px;
    }
    #color-key {
        height: 150px;
        width: 20px;
        margin-left: 20px;
        border-left: 2px solid #333;
        background: linear-gradient(to top, #FEB24C, #FD8D3C, #FC4E2A, #E31A1C, #BD0026, #800026);
    }
    #legend {
        position: absolute;
        bottom: 25px;
        right: 25px;
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
    }
    #legend span {
        display: block;
        margin-top: 10px;
        font-size: 40px;
    }
    #legend span:first-of-type {
        margin-top: 0;
    }
</style>
<body>
    <div id="map" style="position: fixed; right: 0; left: 0; top: 0; bottom: 0;"></div>
    <div id="selectedLayer"></div>
    <div id="legend" style="position: absolute; bottom: 20px; right: 20px;">
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #800026;"></div>
            <div style="margin-left: 10px;"> > 50</div>
        </div>
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #BD0026;"></div>
            <div style="margin-left: 10px;"> > 30</div>
        </div>
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #E31A1C;"></div>
            <div style="margin-left: 10px;"> > 20</div>
        </div>
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #FC4E2A;"></div>
            <div style="margin-left: 10px;"> > 5</div>
        </div>
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #FD8D3C;"></div>
            <div style="margin-left: 10px;"> > 1</div>
        </div>
        <div style="display: flex;">
            <div style="width: 20px; height: 20px; background-color: #FEB24C;"></div>
            <div style="margin-left: 10px;"> <= 1</div>
        </div>
        <h4>Frequency</h4>
    </div>
    <!-- JS IMPORTS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="js/setup.js"></script>
    <script src="js/data.js"></script>
    <script>
        function getContinent(data, CONTINENT) {
            var filteredData = {"type":"FeatureCollection","features":[]};
            for (var i = 0; i < data.features.length; i++) {
                if (data.features[i].properties.CONTINENT === CONTINENT) {
                    filteredData.features.push(data.features[i]);
                }
            }
            return filteredData;
        }

        var continents = {
            "Africa": getContinent(data, "Africa"),
            "Antarctica": getContinent(data, "Antarctica"),
            "Asia": getContinent(data, "Asia"),
            "North America": getContinent(data, "North America"),
            "South America": getContinent(data, "South America"),
            "Australia": getContinent(data, "Oceania"),
            "Europe": getContinent(data, "Europe")
        };

        var map = L.map('map').setView([51.505, -0.09], 13); // Set your initial view or dynamic based on data

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        function setColorFunc(size) {
            return size > 50 ? '#800026' :
                   size > 30 ? '#BD0026' :
                   size > 20  ? '#E31A1C' :
                   size > 5   ? '#FC4E2A' :
                   size > 1   ? '#FD8D3C' :
                                '#FEB24C';
        }

        function styleFunc(feature) {
            return {
                fillColor: setColorFunc(feature.properties.FREQUENCY),
                fillOpacity: 0.9,
                weight: 1,
                opacity: 1,
                color: '#ffffff',
                dashArray: '3'
            };
        }

        function createPopupContent(feature) {
            var frequency = feature.properties.FREQUENCY;
            return "<div style='font-size:20px'>" +
                   "<strong>Country:</strong> " + feature.properties.countriesPracIR + "<br>" +
                   "<strong>Number of Respondents:</strong> " + frequency + "<br>" +
                   "<strong>Diagnostic Radiology:</strong> " + feature.properties.SUM_DR + " (" + ((feature.properties.SUM_DR / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Interventional Radiology:</strong> " + feature.properties.SUM_IR + " (" + ((feature.properties.SUM_IR / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Interventional Radiology Trained:</strong> " + feature.properties.SUM_IRtrain + " (" + ((feature.properties.SUM_IRtrain / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Interventional Radiology Graduated:</strong> " + feature.properties.SUM_Irgraduate + " (" + ((feature.properties.SUM_Irgraduate / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Accredited Training:</strong> " + feature.properties.SUM_accredTrain + " (" + ((feature.properties.SUM_accredTrain / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Faculty/Professor:</strong> " + feature.properties.SUM_facProf + " (" + ((feature.properties.SUM_facProf / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Practice Interventional Radiology:</strong> " + feature.properties.SUM_pracIR + " (" + ((feature.properties.SUM_pracIR / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Resident:</strong> " + feature.properties.SUM_resident + " (" + ((feature.properties.SUM_resident / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>Fellow:</strong> " + feature.properties.SUM_fellow + " (" + ((feature.properties.SUM_fellow / frequency) * 100).toFixed(2) + "%)<br>" +
                   "<strong>More Info:</strong> <a href='https://drive.google.com/drive/u/1/folders/1oPlh7vKmmysZSTW1z0-p9oXdw_nR2tC5'>Click Here</a><br>" +
                   "</div>";
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomFeature
            });
            layer.bindPopup(createPopupContent(feature));
            layer.bindTooltip(feature.properties.countriesPracIR, {
                permanent: true,
                direction: "center",
                className: "building-label",
                opacity: 0.9,
                backgroundColor: null,
                textColor: "#000000"
            });
        }

        var layers = {};
        for (var continent in continents) {
            layers[continent] = L.geoJSON(continents[continent], {
                style: styleFunc,
                onEachFeature: onEachFeature
            }).addTo(map);
        }

        L.control.layers(layers, {}, {collapsed:false}).addTo(map);

        function resetHighlight(e) {
            for (var layerName in layers) {
                layers[layerName].resetStyle(e.target);
            }
        }

        function zoomFeature(e) {
            map.fitBounds(e.target.getBounds().pad(1.5));
        }

        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
        }
    </script>
</body>
</html>
